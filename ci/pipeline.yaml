resource_types:
- name: pull-request
  type: docker-image
  source:
    repository: jtarchie/pr

resources:
- name: resource-app-code
  type: git
  source:
    uri: https://github.com/gaorlov/demoapp
    branch: master

- name: repo
  type: pull-request
  source:
    access_token: {{access-token}}
    repo: gaorlov/demoapp

- name: pr-image
  type: docker-image
  source:
    repository: avvo/demoapp
    username: {{dockerhub-username}}
    password: {{dockerhub-password}}
    tag: gaorlov-candidate


jobs:
- name: monitor-pull-requests
  plan:
  - get: repo
    trigger: true
  - put: repo
    params:
      path: repo
      status: pending
  - put: pr-image
    params:
      build: repo

- name: test-pr-image
  plan:
  - get: pr-image
    trigger: true
  - get: repo
  - task: run the actual test
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: avvo/demoapp
          username: {{dockerhub-username}}
          password: {{dockerhub-password}}
          tag: gaorlov-candidate
      run:
        path: sh
        args:
        - -c
        - cd /srv/demoapp/current && bundle install --local --without development && RAILS_ENV=test bin/rake test

  - put: repo
    params:
      path: repo
      status: success
